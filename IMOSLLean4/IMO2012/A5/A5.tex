Let $R$ be a ring and $S$ be a domain.
Find all functions $f : R \to S$ such that, for any $x, y \in R$,
\[ f(xy + 1) = f(x) f(y) + f(x + y). \tag{*}\label{2012a5-eq0} \]

\textbf{Warning.}
The original problem uses the above functional equation with $R = S = \R$ and an extra condition, $f(-1) \neq 0$.
This problem is an extreme buffed version of the original problem.
The difficulty level of this problem is far beyond the level of IMO.
Proceed with caution; the solution might be very hard to understand.









\subsection*{Answer}

Before proceeding, note the following.
Given a good function $f : R \to S$ and homomorphisms $\phi : R' \to R$ and $\iota : S \to S'$, it is easy to check that $\iota \circ f \circ \phi$ is good.
The functions we will list below are the "initial" functions.
All good functions are of form $\phi \circ f \circ \iota$ where $f$ is a good function on the list.
Here is the list of initial functions:

\begin{itemize}

    \item
    The zero function.
    
    \item
    The function $x \in R \mapsto x - 1$ on a ring $R$.

    \item
    The function $x \in R \mapsto x^2 - 1 \in R_2$, where $R$ is a commutative ring and $R_2$ is the subring of $R$ generated by squares.
    
    \item
    One of the six functions below:
    \begin{align*}
        \F_2 &\to \Z    & \F_3 &\to \Z    & \F_3 &\to \Z    & \Z/4\Z &\to \Z  & \F_2[X]/\langle X^2 \rangle &\to \Z   & \F_4 &\to \Z[\varphi] \\
        0 &\mapsto -1   & 0 &\mapsto -1   & 0 &\mapsto -1   & 0 &\mapsto -1   & 0 &\mapsto -1                         & 0 &\mapsto -1 \\
        1 &\mapsto 0    & 1 &\mapsto 0    & 1 &\mapsto 0    & 1 &\mapsto 0    & 1 &\mapsto 0                          & 1 &\mapsto 0  \\
                       && 2 &\mapsto 1    & 2 &\mapsto 0    & 2 &\mapsto 1    & X &\mapsto 1                          & X &\mapsto \varphi  \\
                                                       &&&&&& 3 &\mapsto 0    & X + 1 &\mapsto 0                      & X + 1 &\mapsto 1 - \varphi
    \end{align*}
    For the last function, $\varphi$ is the golden ratio $\frac{1 + \sqrt{5}}{2}$.

\end{itemize}









\subsection*{Solution}

It is easy to check that the zero function and $x \mapsto x - 1$ are good.
To check the third function, it suffices to check that $x \mapsto x^2 - 1$ on a commutative ring is good, which can be bashed.
Finally, the six functions in the above table have finite input ring, so again we can bash to verify that they are all good functions.
Now we focus on proving that there are no other good functions.

We say that a good function $f : R \to S$ is \emph{non-trivial good} if $f(1) = 0$ and $f(0) = -1$.
We say that $f$ is \emph{reduced good} if $f$ is non-trivial and $f$ has no non-zero periodic element.
That is, $f(x + c) = f(x + d)$ for all $x \in R$ implies $c = d$.

We start with some easy observations.
Plugging $x = y = 1$ yields $f(1) = 0$.
Then plugging $y = 0$ yields either $f \equiv 0$ and $f(0) = -1$.
That is, if $f$ is not the zero function, then $f$ is non-trivial good.
We now continue with more observations.




\subsubsection*{Quasi-periodic elements}

We say that $c \in R$ is \emph{quasi-periodic} if one of the following conditions hold:
\begin{itemize}
    \item   $f(c + x) = -f(c) f(x)$ for all $x \in R$,
    \item   $f(cx + 1) = 0$ for all $x \in R$,
    \item   $f(x + c) = -f(x) f(c)$ for all $x \in R$,
    \item   $f(xc + 1) = 0$ for all $x \in R$.
\end{itemize}

Actually, we will show shortly that these four conditions are all equivalent.
Indeed, by~\eqref{2012a5-eq0}, the first two and the last two are equivalent.
For the first and third, we prove a more general result.

\begin{claim}
For any $c \in R$ satisfying the first or the third condition, we have $f(c) = f(-c) = \pm 1$.
\end{claim}
\begin{proof}
By symmetry, we can assume that $c \in R$ satisfies the first condition.
Then $f(c + 1) = -f(c) f(1) = 0$, and so~\eqref{2012a5-eq0} with $(x, y) = (c + 1, -1)$ yields $f(-c) = f(c)$.
For the last equality, note that $-f(c)^2 = -f(c) f(-c) = f(0) = -1$.
Thus we get $f(c)^2 = 1 \iff f(c) = \pm 1$.
\end{proof}

In particular, $f(c)$ always commutes with $f(x)$.
This shows that the first and third condition are indeed equivalent.
Thus, all four conditions are indeed equivalent.

Now let $J \subseteq R$ be the set of quasi-periodic elements.
The first condition yields that $J$ is closed under addition.
The second and fourth condition yields that $J$ is closed under right and left multiplication by elements of $R$, respectively.
Thus, $J$ is a two-sided ideal of $R$.

\begin{lemma}\label{2012a5-quasi-periodic-non-zero}
Suppose that $f$ is reduced and $J$ contains a non-zero element, say $c$.
Then $R = \{0, 1, c, c + 1\}$.
\end{lemma}
\begin{proof}
First note that $f(c) = \pm 1$ for any $c \in J$.
If $f(c) = -1$, then $f(x + c) = f(x)$ for all $x \in R$ and thus $c = 0$.
Thus, if $c \in J$ is non-zero, then $f(c) = 1$.
This case is possible only if $\rchar(S) \nmid 2$, so we will assume this.

Now fix a non-zero element $c \in J$.
Then $f(c) = 1$, and so $f(x + c) = -f(x)$ for all $x \in R$.
For any $d \in J$ non-zero, this yields $1 = f(d) = -f(d - c)$.
So $f(d - c) = -1$ and so, since $d - c \in J$, this implies $d = c$.
In summary, $J = \{0, c\}$.

Next, we show that for any $d \in R$, if $dc = 0$, then $d \in J$.
Indeed, for any $x \in R$, we have
\[ f(dx + 1) = f(d(x + c) + 1) = f(d) f(x + c) + f(d + x + c) = -(f(d) f(x) + f(d + x)) = -f(dx + 1). \]
Since $\rchar(S) \nmid 2$, this means $f(dx + 1) = 0$ for all $x \in J$.
Thus $d \in J$, as desired.

Finally, for any $r \in R$, we have $rc \in J = \{0, c\}$, so either $rc = 0$ or $(r - 1)c = 0$.
By the above result, the former yields $r \in \{0, c\}$, and the latter yields $r \in \{1, c + 1\}$.
\end{proof}




\subsubsection*{Periodic elements}

Consider the set $I$ of periodic elements of $R$ (with respect to $f$).
That is, $I = \{c \in R : \forall x \in R, f(x + c) = f(x)\}$.
Here, we prove that $I$ is in fact a double-sided ideal of $R$.
Clearly $I$ is a group under addition, so we just have to prove that it is closed under multiplication from both sides.
By symmetry, it suffices to show that $dc \in I$ for any $d \in R$ and $c \in I$.

Let $J$ be the ideal of quasi-periodic elements as in the previous part.
Clearly, $c \in I$ implies $f(c) = f(0) = -1$ and $c \in J$.
The converse is easy to check, so we have
\[ c \in I \iff c \in J \wedge f(c) = -1. \]

Now fix $c \in I$ and $d \in R$; the goal is to show that $dc \in I$.
Since $J$ is a two-sided ideal, we have $dc \in J$ and thus $f(dc) = \pm 1$.
The goal is to show that $f(dc) = -1$.

\begin{proof}
Since $c \in I$, for any $x \in R$ we have
\[ f(d) f(c + x) + f(d + c + x) = f(d) f(x) + f(d + x) \implies f(dc + dx + 1) = f(dx + 1). \]
But $dc \in J$, so this gives us $-f(dx + 1) = f(dx + 1)$.
Thus, either $\rchar(S) = 2$ or $f(dx + 1) = 0$ for all $x \in R$.
In the former case, we are done since $f(dc) = \pm 1 = -1$.
The latter case means that $d \in J$.
Thus, for any $d \in R$, either $dc \in I$ or $d \in J$.

Now if $d \in J$, then $d - 1 \notin J$, so $(d - 1)c \in I$.
Since $c \in I$, we still get $dc \in I$.
Either way, we have $dc \in I$ for any $d \in R$, as desired.
\end{proof}

Since $I$ is a two-sided ideal and $f(x + c) = f(x)$ for any $c \in I$, $f$ lifts to a function $\tilde{f} : R/I \to S$.
That is, $\tilde{f}$ satisfies $f = \tilde{f} \circ q$, where $q : R \to R/I$ is the canonical quotient map.
One can check that $\tilde{f}$ is a reduced good map.
Using this result, from now on, we can assume that $f$ is a reduced good map whenever necessary.




\subsubsection*{A solver for $f(x + 1) = f(x) + 1$.}

We now solve the problem when $f(x + 1) = f(x) + 1$ for all $x \in R$.
The result is as follows:

\begin{lemma}\label{2012a5-linear-solver}
Let $f : R \to S$ be a non-trivial good map such that $f(x + 1) = f(x) + 1$ for all $x \in R$.
Then $f + 1$ is a ring homomorphism.
\end{lemma}
\begin{proof}
First we reduce the lemma to showing that $f + 1$ is additive.
Equivalently, $f(x + y) = f(x) + f(y) + 1$ for all $x, y \in R$.
Indeed, if $f + 1$ is additive, then for any $x, y \in R$,
\[ f(xy) + 1 = f(xy + 1) = f(x) f(y) + f(x + y) = f(x) f(y) + f(x) + f(y) + 1 = (f(x) + 1)(f(y) + 1). \]
Thus $f + 1$ is multiplicative.
Since $f(1) + 1 = 1$, this would prove that $f + 1$ is a ring homomorphism.
Before proceeding, note that for any $x, y \in R$,
\[ f(xy) = f(xy + 1) - 1 = f(x) f(y) + f(x + y) - 1. \]

Now fix $x, y \in R$; we show that $f(x + y) = f(x) + f(y) + 1$.
The trick is to write $f(x(x + 1) y + 1)$ in two ways.
Let $a = f(x)$, $b = f(y)$, and $c = f(x + y)$, and note again that $f(x + 1) = f(x) + 1$ for all $x \in R$.
We get
\begin{align*}
    a f((x + 1) y) + f(x + (x + 1) y) &= (a + 1) f(xy) + f(x + 1 + xy) \\
    a((a + 1) b + c) + (a + 1)(b + 1) + c &= (a + 1) (ab + c - 1) + a(b + 1) + c + 1
\end{align*}
    which simplifies to $c = a + b + 1$ after some heavy algebraic manipulation.
It is the desired equality.
\end{proof}




%% ...
